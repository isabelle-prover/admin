<VirtualHost _default_:443>
  ServerName {{ config.domains.afp }}
  ServerAdmin info@isabelle.systems

  DocumentRoot /var/www/afp

  <Location />
    Require all granted
    Options +Includes
    AddType text/html .shtml
    AddOutputFilter INCLUDES .shtml
    DirectoryIndex index.shtml index.html
  </Location>

  ErrorLog ${APACHE_LOG_DIR}/error.log
  LogLevel warn
  CustomLog ${APACHE_LOG_DIR}/access.log combined

  Header set Content-Security-Policy "default-src 'self' search.isabelle.in.tum.de; frame-src ci.isabelle.systems; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src *"
  Header set Strict-Transport-Security "max-age=31536000; includeSubdomains"
  Header set X-Xss-Protection "1; mode=block"

  SSLEngine On
  SSLProtocol all -SSLv2 -SSLv3
  SSLCipherSuite EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH
  SSLHonorCipherOrder On
  SSLCompression off

  SSLCertificateFile /etc/letsencrypt/live/{{ config.apache.cert_name }}/cert.pem
  SSLCertificateKeyFile /etc/letsencrypt/live/{{ config.apache.cert_name }}/privkey.pem
  SSLCertificateChainFile /etc/letsencrypt/live/{{ config.apache.cert_name }}/chain.pem

  RewriteEngine on
  RewriteRule "^/devel-entries/(.+)" "https://{{ config.domains.afp_devel }}/entries/$1" [R=301,L]
  RewriteRule "^/devel.shtml" "https://{{ config.domains.afp_devel }}/" [R=301,L]
  RewriteRule "^/status.shtml" "https://{{ config.domains.afp_devel }}/status.html" [R=301,L]

  RewriteCond %{REQUEST_URI} "^/(.+)\.shtml"
  RewriteCond %{DOCUMENT_ROOT}/%1.html -f
  RewriteRule ^(.*)$ "/%1.html" [R=301,L]
</VirtualHost>

<VirtualHost _default_:443>
  ServerName {{ config.domains.afp_short }}
  ServerAdmin info@isabelle.systems

  DocumentRoot /var/www/afp

  <Location />
    Require all granted
  </Location>

  ErrorLog ${APACHE_LOG_DIR}/error.log
  LogLevel warn
  CustomLog ${APACHE_LOG_DIR}/access.log combined

  Redirect permanent / https://{{ config.domains.afp }}/

  SSLEngine On
  SSLProtocol all -SSLv2 -SSLv3
  SSLCipherSuite EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH
  SSLHonorCipherOrder On
  SSLCompression off

  SSLCertificateFile /etc/letsencrypt/live/{{ config.apache.cert_name }}/cert.pem
  SSLCertificateKeyFile /etc/letsencrypt/live/{{ config.apache.cert_name }}/privkey.pem
  SSLCertificateChainFile /etc/letsencrypt/live/{{ config.apache.cert_name }}/chain.pem
</VirtualHost>

<VirtualHost _default_:443>
  ServerName {{ config.domains.afp_devel }}
  ServerAdmin info@isabelle.systems

  DocumentRoot /var/www/afp-devel

  <Location />
    Require all granted
    Options +Includes
    AddType text/html .shtml
    AddOutputFilter INCLUDES .shtml
    DirectoryIndex index.shtml index.html
  </Location>

  ErrorLog ${APACHE_LOG_DIR}/error.log
  LogLevel warn
  CustomLog ${APACHE_LOG_DIR}/access.log combined

  Header set Content-Security-Policy "default-src 'self' search.isabelle.in.tum.de; frame-src ci.isabelle.systems; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src *"
  Header set Strict-Transport-Security "max-age=31536000; includeSubdomains"
  Header set X-Xss-Protection "1; mode=block"

  SSLEngine On
  SSLProtocol all -SSLv2 -SSLv3
  SSLCipherSuite EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH
  SSLHonorCipherOrder On
  SSLCompression off

  SSLCertificateFile /etc/letsencrypt/live/{{ config.apache.cert_name }}/cert.pem
  SSLCertificateKeyFile /etc/letsencrypt/live/{{ config.apache.cert_name }}/privkey.pem
  SSLCertificateChainFile /etc/letsencrypt/live/{{ config.apache.cert_name }}/chain.pem

  RewriteEngine On
  RewriteCond %{REQUEST_URI} "^/(.+)\.shtml"
  RewriteCond %{DOCUMENT_ROOT}/%1.html -f
  RewriteRule ^(.*)$ "/%1.html" [R=301,L]
</VirtualHost>
